{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Dashboard Emergencia - Las Malvinas </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root{
      --accent:#0069d9;
      --card-bg:linear-gradient(135deg,#ffffff, #f3f7ff);
    }
    body { background:black; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; overflow-x: hidden; overflow-y: auto; color: #e6eef8; }
    nav.navbar { box-shadow: 0 4px 18px rgba(10,20,40,0.08); position:relative; z-index:1000; }
    #map { height:520px; border-radius:10px; box-shadow: 0 6px 20px rgba(10,20,40,0.08); background:#fff; }
    .card-spot { min-height:120px; background: var(--card-bg); border:0; box-shadow: 0 6px 18px rgba(50,60,80,0.05); border-radius:10px; color:#002; }
    .small-muted { color:#9aa4b2 }
    .btn-accent { background: var(--accent); color:#fff; border:0 }
    .controls { position:static; margin-top: 10px; }
    .legend-pill { display:inline-block; padding:6px 10px; border-radius:999px; background: rgba(0,0,0,0.04); margin-right:8px; font-size:13px }
    #setEpicBtn { margin-top:10px; }

    /* ---- Fondo animado ---- */
    .wrap {
      position: fixed;
      inset: 0;
      z-index: -1;
      overflow: hidden;
    }
    .c {
      position: absolute;
      height: 400px;
      width: 0.69444%;
      margin-top: -400px;
      animation: drop 4s infinite ease-in;
    }
    .c::after {
      content: "";
      position: absolute;
      width: 0.9vw;
      height: 0.9vw;
      border-radius: 50%;
      left: 50%;
      bottom: -0.45vw;
      margin-left: -0.45vw;
    }
    @keyframes drop {
      80% { opacity: 1; }
      100% {
        transform: translate3d(0, 150vh, 0);
        opacity: 0;
      }
    }
    main.container { position:relative; z-index:1001; }

    /* pequeño estilo para botones de puentes (no rompe layout) */
    .bridge-controls { display:inline-flex; gap:6px; margin-left:8px; }
    .bridge-btn { font-size:12px; padding:4px 8px; }

    /* Zona de exclusión card (footer) */
    .exclusion-card {
      max-width: 980px;
      margin: 22px auto;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 30px rgba(0,0,0,0.45);
      background: linear-gradient(180deg, rgba(255,69,58,0.06), rgba(255,69,58,0.03));
      border: 1px solid rgba(255,69,58,0.12);
      color: #fff;
    }
    .exclusion-card .card-body { display:flex; gap:16px; align-items:center; }
    .alarm-icon {
      width:72px; height:72px; flex: 0 0 72px; display:flex; align-items:center; justify-content:center;
      background: radial-gradient(circle at 30% 30%, rgba(255,69,58,0.14), rgba(255,69,58,0.06));
      border-radius: 10px;
      border: 1px solid rgba(255,69,58,0.14);
    }
    .exclusion-title { color:#ff4d4f; font-weight:700; margin:0; font-size:1.15rem; }
    .exclusion-sub { color:#ffd7d2; margin:0; font-size:0.95rem; }
    .exclusion-cta .btn { background:#ff4d4f; color:#fff; border:0; border-radius:8px; padding:10px 14px; box-shadow: 0 6px 14px rgba(255,77,79,0.18); }
    .exclusion-cta .btn:hover { filter:brightness(.95); }
    @media (max-width: 767px) {
      .exclusion-card .card-body { flex-direction: column; text-align:center; }
      .alarm-icon { margin-top:6px; }
    }

    /* Services horizontal compact */
    .services-inline { display:flex; gap:18px; flex-wrap:wrap; align-items:center; }
    .services-inline li { list-style:none; margin:0; padding:0; font-size:0.92rem; color:#cfe6ff; }

    /* Bigger evaluation chart area */
    #structEvalWrapper { margin-top:18px; }
    #structEvalChart { width:100% !important; height:360px !important; background:#fff; border-radius:8px; padding:8px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); }

    /* Center map column visually */
    .map-card { display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .map-inner { width:100%; max-width: 960px; }

    /* Chart canvases sizing */
    #victimsTime { width:100%; height:180px; }
    #popDonut { width:100%; height:320px; }

    /* small adjustments */
    .card .card-body small { color:#8aa0b8; }
  </style>
</head>
<body>
  <!-- Fondo dinámico -->
  <div class="wrap" id="bgWrap"></div>

<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand mx-auto" href="#">Terremoto Las Malvinas — Dashboard</a>
    <div class="d-flex align-items-center text-white-50 small">
      <span class="me-3">72h iniciales</span>
      <button id="zoomEpic" class="btn btn-sm btn-light">Ir a epicentro</button>
    </div>
  </div>
</nav>

<main class="container py-4">
  <!-- Síntesis textual (mantengo pero compacto) -->
  <div class="card mb-3">
    <div class="card-body">
      <h6 class="card-title">SÍNTESIS DEL EVENTO</h6>
      <p class="card-text small" id="synthesis"></p>
    </div>
  </div>

  <!-- tarjetas -->
  <section class="row g-3 mb-3" id="summary-cards"></section>

  <section class="row g-3 mb-4 position-relative">
    <div class="col-lg-8 map-card">
      <div class="card p-3 map-inner">
        <h5>Mapa — epicentro, puentes y refugios</h5>
        <div id="map"></div>

        <div class="mt-2 text-center">
          <button id="setEpicBtn" class="btn btn-sm btn-outline-danger">Definir epicentro manualmente</button>
          <span class="bridge-controls">
            <button id="defBridge1" class="btn btn-sm btn-outline-warning bridge-btn">Definir Puente 1</button>
            <button id="defBridge2" class="btn btn-sm btn-outline-warning bridge-btn">Definir Puente 2</button>
          </span>
        </div>
        <div class="mt-2 small-muted text-center">
          <span class="legend-pill">● Epicentro</span>
          <span class="legend-pill">● Puentes</span>
          <span class="legend-pill">● Refugios</span>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card p-3 mb-3">
        <h6>Servicios básicos</h6>
        <ul id="servicesList" class="services-inline mb-0">
          <!-- se llenará con JS en formato horizontal -->
        </ul>
      </div>

      <div class="card p-3 mb-3">
        <h6>Heridos y Fallecidos (serie temporal)</h6>
        <canvas id="victimsTime"></canvas>
      </div>

      <div class="card p-3">
        <h6>Distribución población</h6>
        <canvas id="popDonut"></canvas>
      </div>
    </div>
  </section>

  <!-- EVALUACIÓN ESTRUCTURAS CRÍTICAS: fila completa grande debajo -->
  <section id="structEvalWrapper" class="row">
    <div class="col-12">
      <div class="card p-3">
        <h6>EVALUACIÓN ESTRUCTURAS CRÍTICAS (ESCALA 1-5)</h6>
        <div id="structEvalChart">
          <canvas id="hospCapChart"></canvas>
        </div>
      </div>
    </div>
  </section>

</main>

<!-- ---------- CARD FINAL: Zona de Exclusión ---------- -->
<div class="exclusion-card" role="region" aria-label="Zona de exclusión">
  <div class="card-body">
    <div class="alarm-icon" aria-hidden="true">
      <!-- simple icono de alarma SVG -->
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M12 2L2 7v5c0 5 3.58 9.74 10 11 6.42-1.26 10-6 10-11V7l-10-5z" fill="#ff4d4f"/>
        <path d="M11 10h2v5h-2zM11 16h2v2h-2z" fill="#fff"/>
      </svg>
    </div>

    <div style="flex:1;">
      <p class="exclusion-title">ZONA DE EXCLUSION — FALLA MALVINAS</p>
      <p class="exclusion-sub">Área marcada en Google Earth. Abrir para ver detalles y límites.</p>
    </div>

    <div class="exclusion-cta">
      <a class="btn" href="https://earth.google.com/earth/d/1fsrEOy9AkDASZ2KZyHTPtOI0kaG6Rb7V?usp=sharing" target="_blank" rel="noopener noreferrer" title="Abrir Zona de Exclusión en Google Earth">
        Abrir en Google Earth
      </a>
    </div>
  </div>
</div>

<!-- scripts al final -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ---- Fondo dinámico JS ---- */
(function(){
  const wrap = document.getElementById('bgWrap');
  const total = 144;
  for(let i=1;i<=total;i++){
    const c = document.createElement('div');
    c.className = 'c';
    const percent = 0.69444;
    const left = (i-1)*percent;
    const hue = (300/total)*i;
    c.style.left = left + '%';
    c.style.backgroundImage = `linear-gradient(to bottom, black, hsla(${hue},100%,50%,.8))`;
    const delay = Math.random()* (4/total) * -total;
    c.style.animationDelay = delay+'s';
    wrap.appendChild(c);
  }
})();

/* ---------- Helpers ---------- */
function safeGet(obj, path, fallback = null) {
  try { return path.split('.').reduce((o,k)=> (o && o[k] !== undefined) ? o[k] : fallback, obj); }
  catch(e) { return fallback; }
}
async function fetchSummary() {
  const resp = await fetch('/api/summary/');
  if (!resp.ok) throw new Error('No se pudo obtener /api/summary/ : ' + resp.status);
  return await resp.json();
}
async function fetchMetrics() {
  const resp = await fetch('/api/metrics/');
  if (!resp.ok) return {};
  return await resp.json();
}
function createCard(title, subtitle, value, id) {
  const progress = (id === 'hospitalCap') ? `<div class="progress mt-2" style="height:10px;"><div class="progress-bar" id="${id}-bar" role="progressbar" style="width:${value};" aria-valuenow="${parseInt(value)}" aria-valuemin="0" aria-valuemax="100"></div></div>` : '';
  return `<div class="col-md-3"><div class="card p-3 card-spot">
    <div class="small text-muted">${subtitle}</div>
    <h3 id="${id}">${value}</h3>
    ${progress}
    <div class="small text-muted">${title}</div>
  </div></div>`;
}

let charts = {};
let leafletState = { map: null, epicMarker: null, epicCircle: null, bridgesLayer: null, sheltersLayer: null };

/* ---------- Charts ---------- */
function renderCharts(metrics, summary) {
  // Víctimas (línea)
  const labels = (metrics.fatalities || []).map(p => new Date(p.timestamp).toLocaleTimeString());
  const fatalitiesData = (metrics.fatalities || []).map(p => p.value);
  const severeData = (metrics.injured_severe || []).map(p => p.value);
  const mildData = (metrics.injured_mild || []).map(p => p.value);

  if (charts.victimsTime) charts.victimsTime.destroy();
  charts.victimsTime = new Chart(document.getElementById('victimsTime'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        { label: 'Fallecidos', data: fatalitiesData, borderColor: 'red', fill: false },
        { label: 'Heridos graves', data: severeData, borderColor: 'orange', fill: false },
        { label: 'Heridos leves', data: mildData, borderColor: 'green', fill: false }
      ]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } }
  });

  // Distribución población (donut)
  if (charts.popDonut) charts.popDonut.destroy();
  charts.popDonut = new Chart(document.getElementById('popDonut'), {
    type: 'doughnut',
    data: {
      labels: ['Afectados', 'No afectados'],
      datasets: [{ data: [summary.affected || 1050, (summary.population || 3500) - (summary.affected || 1050)], backgroundColor: ['#dc3545','#28a745'] } ]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
  });

  // --- EVALUACION ESTRUCTURAS CRITICAS (barra horizontal grande) ---
  const structLabels = [
    'Salas médicas',
    'Escuelas',
    'Estaciones de bombeo',
    'Subestaciones',
    'Puente RP 179',
    'Puente RP 175'
  ];
  const structValues = [4, 2, 1, 4, 5, 5];
  const structColors = [
    '#ff8800', // naranja
    '#5bc0de', // celeste
    '#28a745', // verde
    '#ff8800', // naranja
    '#ff4d4f', // rojo
    '#ff4d4f'  // rojo
  ];

  if (charts.structEval) charts.structEval.destroy();
  charts.structEval = new Chart(document.getElementById('hospCapChart'), {
    type: 'bar',
    data: {
      labels: structLabels,
      datasets: [{
        label: 'Evaluación (1-5)',
        data: structValues,
        backgroundColor: structColors,
        borderRadius: 6,
        barThickness: 22,
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.parsed.x + ' / 5';
            }
          }
        }
      },
      scales: {
        x: {
          min: 0,
          max: 5,
          ticks: {
            stepSize: 1
          },
          title: { display: true, text: 'Nivel (1 = buen estado, 5 = crítico)' }
        },
        y: {
          beginAtZero: true
        }
      }
    }
  });
}

/* ---------- Mapa ---------- */

/* Iconos */
const bridgeIcon = L.divIcon({
  className: 'bridge-icon',
  html: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 13h18" stroke="#e74c3c" stroke-width="2" stroke-linecap="round"/><path d="M6 9v4" stroke="#e74c3c" stroke-width="2" stroke-linecap="round"/><path d="M18 9v4" stroke="#e74c3c" stroke-width="2" stroke-linecap="round"/></svg>',
  iconSize:[24,24], iconAnchor:[12,12]
});
const epicIcon = undefined;

/* LocalStorage key para puentes */
const BRIDGES_KEY = 'broken_bridges';

let defineMode = null;

function loadBridges(){
  try { const raw = localStorage.getItem(BRIDGES_KEY); return raw ? JSON.parse(raw) : []; }
  catch(e){ return []; }
}
function saveBridges(list){
  localStorage.setItem(BRIDGES_KEY, JSON.stringify(list));
}

function updateBridgesOnMap(){
  if(!leafletState.map) return;
  if(!leafletState.bridgesLayer) {
    leafletState.bridgesLayer = L.layerGroup().addTo(leafletState.map);
  }
  leafletState.bridgesLayer.clearLayers();
  const list = loadBridges();
  list.forEach(b => {
    const m = L.marker([b.lat, b.lng], { icon: bridgeIcon, draggable:true, title: b.name || ('Puente '+b.id) });
    m.addTo(leafletState.bridgesLayer);
    m.on('dragend', function(){
      const p = m.getLatLng();
      const arr = loadBridges();
      const idx = arr.findIndex(x => x.id === b.id);
      if(idx !== -1){ arr[idx].lat = p.lat; arr[idx].lng = p.lng; saveBridges(arr); }
    });
  });
}

function placeBridge(id, lat, lng, name){
  const arr = loadBridges();
  const existing = arr.find(x => x.id === id);
  if(existing){ existing.lat = lat; existing.lng = lng; if(name) existing.name = name; }
  else { arr.push({ id, lat, lng, name: name || ('Puente '+id) }); }
  saveBridges(arr);
  updateBridgesOnMap();
}

function updateEpicOnMap(lat, lng, store=true) {
  const epic = [lat, lng];
  if (!leafletState.map) return;
  if (!leafletState.epicMarker) {
    leafletState.epicMarker = L.marker(epic, { draggable:true, title: 'Epicentro' }).addTo(leafletState.map);
    leafletState.epicCircle = L.circle(epic, { radius: 1200, color:'#b30000', fill:false, dashArray:'6 6' }).addTo(leafletState.map);
    leafletState.epicMarker.on('dragend', ()=>{ const p = leafletState.epicMarker.getLatLng(); if (store) localStorage.setItem('epicentro_coords', JSON.stringify({lat:p.lat,lng:p.lng})); leafletState.epicCircle.setLatLng(p); });
  } else {
    leafletState.epicMarker.setLatLng(epic);
    leafletState.epicCircle.setLatLng(epic);
  }
  if (store) localStorage.setItem('epicentro_coords', JSON.stringify({lat, lng}));
}

function initMapWithBridges(defaultCoords){
  if (!leafletState.map) {
    leafletState.map = L.map('map', { minZoom:5 }).setView([defaultCoords.lat, defaultCoords.lng], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(leafletState.map);
    updateEpicOnMap(defaultCoords.lat, defaultCoords.lng, false);
  }

  updateBridgesOnMap();

  leafletState.map.on('click', function(e){
    if(!defineMode) return;
    if(defineMode.type === 'bridge'){
      placeBridge(defineMode.id, e.latlng.lat, e.latlng.lng);
      defineMode = null;
      setTimeout(()=> alert('Puente guardado.'), 100);
      updateBridgesOnMap();
    } else if(defineMode.type === 'epic'){
      updateEpicOnMap(e.latlng.lat, e.latlng.lng, true);
      defineMode = null;
      setTimeout(()=> alert('Epicentro guardado.'), 100);
    }
  });
}

/* ---------- Init ---------- */
async function init() {
  try {
    const [data, metrics] = await Promise.all([fetchSummary(), fetchMetrics()]);
    // síntesis
    document.getElementById('synthesis').textContent =
      `MAGNITUD SISMO: ~6.8   |   HORA: 04:17 |   TEMPERATURA: -3°C.`;

    // tarjetas (mantengo tu lógica para población/fallecidos)
    const cardsEl = document.getElementById('summary-cards');
    cardsEl.innerHTML = '';
    cardsEl.innerHTML += createCard('Población total', 'Distrito: Las Malvinas', (data.population || 3500), 'popTotal');
    cardsEl.innerHTML += createCard('Personas afectadas', 'Estimación 25-35%', (data.affected || 1050), 'affected');
    cardsEl.innerHTML += createCard('Fallecidos proyectados', '72h', (data.fatalities || 80), 'fatalities');
    cardsEl.innerHTML += createCard('Capacidad hospitalaria', 'Operativa inicial', Math.round((data.hospital_operational_pct || 0.4) * 100) + '%', 'hospitalCap');

    // servicios: rellenar en formato horizontal compacto
    const servicesEl = document.getElementById('servicesList');
    servicesEl.innerHTML = '';
    const svc = data.services || [
      {name:'Electricidad', status:'Corte total'},
      {name:'Agua', status:'Cortes y baja presión (20-35%)'},
      {name:'Comunicaciones móviles', status:'Sin telefonía móvil ni internet'},
      {name:'Radio local', status:'Activa'},
      {name:'Clima (noches)', status:'Frío -3°C nocturno'}
    ];
    svc.forEach(s => {
      const li = document.createElement('li');
      li.innerHTML = `<strong>${s.name}:</strong> ${s.status}`;
      servicesEl.appendChild(li);
    });

    // coords default / epicentro almacenado
    const defaultCoords = { lat: -34.834762, lng: -68.251582 };
    let coords = safeGet(data, 'coords', defaultCoords);
    try { const stored = JSON.parse(localStorage.getItem('epicentro_coords')); if (stored) coords = stored; } catch(e){}

    // init map
    initMapWithBridges(coords);

    // render charts (victims, donut, structural)
    renderCharts(metrics || {}, data || {});

    // actualizar puentes
    updateBridgesOnMap();

  } catch(err){ console.error(err); }
}
init();

/* ---------- UI Buttons ---------- */
document.getElementById('defBridge1').addEventListener('click', function(){
  defineMode = { type: 'bridge', id: 1 };
  alert('Hacé click en el mapa para definir la ubicación del Puente 1. También podés arrastrar el marcador luego.');
});
document.getElementById('defBridge2').addEventListener('click', function(){
  defineMode = { type: 'bridge', id: 2 };
  alert('Hacé click en el mapa para definir la ubicación del Puente 2. También podés arrastrar el marcador luego.');
});
document.getElementById('setEpicBtn').addEventListener('click', function(){
  defineMode = { type: 'epic' };
  alert('Hacé click en el mapa para definir el epicentro. También podés arrastrar el marcador luego.');
});
document.getElementById('toggleBridges').addEventListener('change', function(e){
  if(!leafletState.map || !leafletState.bridgesLayer) return;
  if(e.target.checked) leafletState.map.addLayer(leafletState.bridgesLayer);
  else leafletState.map.removeLayer(leafletState.bridgesLayer);
});
document.getElementById('zoomEpic').addEventListener('click', function(){
  try {
    const stored = JSON.parse(localStorage.getItem('epicentro_coords'));
    if(stored && leafletState.map) leafletState.map.setView([stored.lat, stored.lng], 14);
  } catch(e){ console.warn(e); }
});

/* Export helper */
function exportBridgesJSON(){
  const data = loadBridges();
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'broken_bridges.json'; a.click(); URL.revokeObjectURL(url);
}
</script>
</body>
</html>
